<!DOCTYPE html>
<html lang="th">
<head>
  <link rel="manifest" href="/manifest-engineer.json">
  <meta charset="UTF-8" />
  <title>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á - ‡∏Å‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: 'Kanit', sans-serif; background: #f1f5f9; margin: 0; padding: 20px; }
    h2 { text-align: center; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: center; vertical-align: middle; }
    th { background: #15563b; color: white; }
    img, video { max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
    .media-container { display: flex; flex-direction: column; align-items: center; gap: 10px; padding: 10px 0; }
    a.map-link { color: #2563eb; font-weight: bold; text-decoration: none; }
    .input { padding: 10px 12px; border-radius: 8px; border: 1px solid #cbd5e1; background:#fff; font-size: 16px; }
    .btn { padding:10px 14px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; font-weight:600; cursor:pointer; }
    .btn.link-yellow { border-color:#eab308; background:#fff8e1; color:#92400e; }
    .counter-bar { text-align:center; margin: -4px 0 16px; }
  </style>
</head>
<body>
  <h2>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á - ‡∏Å‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á</h2>

  <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß -->
  <div style="text-align:center; margin-bottom: 12px;">
    <input type="text" id="searchInput" class="input" placeholder="üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå..." />
    <button id="refreshBtn" class="btn" onclick="refreshData()" style="margin-left:8px;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏Å‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á) -->
  <div class="counter-bar">
    <button id="btn-unset" onclick="location.href='unset-engineer.html'" class="btn link-yellow">
      üìù ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (0)
    </button>
    <button id="btn-pending" onclick="location.href='pending-engineer.html'" class="btn">
      ‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (0)
    </button>
    <button id="btn-inprogress" onclick="location.href='inprogress-engineer.html'" class="btn">
      ‚öôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (0)
    </button>
    <button id="btn-completed" onclick="location.href='completed-engineer.html'" class="btn">
      ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (0)
    </button>
  </div>

  <table>
    <thead>
      <tr>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
        <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
        <th>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</th>
        <th>‡πÑ‡∏ü‡∏•‡πå</th>
        <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</th>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà-‡πÄ‡∏ß‡∏•‡∏≤</th>
        <th>‡πÑ‡∏ü‡∏•‡πå(‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô)</th>
      </tr>
    </thead>
    <tbody id="data-body"></tbody>
  </table>

  <script>
    // ====== STATE ======
    const DEPT = '‡∏Å‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á';
    let allEngineerData = [];
    let currentFiltered = [];
    let debounceTimer = null;

    // ====== INIT ======
    const searchEl = document.getElementById('searchInput');
    searchEl.value = localStorage.getItem('engineer_search') || '';
    searchEl.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        localStorage.setItem('engineer_search', searchEl.value || '');
        applyFilters();
      }, 250);
    });
    searchEl.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { searchEl.value = ''; localStorage.removeItem('engineer_search'); applyFilters(); }
      if (e.key === 'Enter') { applyFilters(); }
    });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å + ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏Ñ‡∏≤‡∏ô‡πå‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏∏‡∏Å 60 ‡∏ß‡∏¥
    loadData();
    updateCounters();
    setInterval(updateCounters, 60000);

    // ====== LOAD & RENDER ======
    async function loadData() {
      const res = await fetch('/data-engineer-all?_=' + Date.now());
      const data = await res.json();
      data.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0)); // ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
      allEngineerData = data;
      applyFilters();
    }

    function applyFilters() {
      const kw = (document.getElementById('searchInput').value || '').trim().toLowerCase();
      const filtered = allEngineerData.filter(row =>
        !kw ||
        (row.name  && String(row.name).toLowerCase().includes(kw)) ||
        (row.phone && String(row.phone).toLowerCase().includes(kw))
      );
      currentFiltered = filtered;
      renderTable(filtered);
    }

    function renderTable(data) {
      const tbody = document.getElementById('data-body');
      tbody.innerHTML = '';

      data.forEach(row => {
        // ---- ‡πÅ‡∏õ‡∏•‡∏á row.photo ‡πÄ‡∏õ‡πá‡∏ô array ----
        let files = [];
        try {
          if (row.photo && typeof row.photo === 'string') {
            files = JSON.parse(row.photo);
          } else if (Array.isArray(row.photo)) {
            files = row.photo;
          }
        } catch (e) { files = []; }

        // üî¥ ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏ï‡∏≠‡∏ô "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"
        const completedFiles = files.filter(it => {
          if (!it || typeof it !== 'object') return false;
          return it.from === 'completed' || it.tag === 'completed';
        });

        // üîµ ‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà completed)
        const mainFiles = files.filter(it => {
          if (!it) return false;
          if (typeof it !== 'object') return true; // string ‡πÄ‡∏Å‡πà‡∏≤ ‡πÜ = ‡∏õ‡∏Å‡∏ï‡∏¥
          return !(it.from === 'completed' || it.tag === 'completed');
        });

        // ----- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡πÑ‡∏ü‡∏•‡πå(‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô)" -----
        let completedLinks = "-";
        if (completedFiles.length > 0) {
          const cf = completedFiles[0];
          const cfUrl = typeof cf === 'string'
            ? (cf.startsWith('uploads/') ? `/${cf}` : cf)
            : (((cf.url || '').startsWith('uploads/')) ? `/${cf.url}` : (cf.url || ''));

          const isVideo = (cf.type === 'video') || /\.(mp4|mov|avi)(\?|$)/i.test(cfUrl);
          const cfElement = isVideo
            ? `<a href="javascript:void(0)" onclick='showImages(${JSON.stringify(completedFiles)})'>
                 <video controls style="width:150px;height:auto;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2);">
                   <source src="${cfUrl}" type="video/mp4">
                 </video>
               </a>`
            : `<a href="javascript:void(0)" onclick='showImages(${JSON.stringify(completedFiles)})'>
                 <img src="${cfUrl}" style="width:150px;height:auto;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2);" />
               </a>`;

          const cfBtn = `
            <button class="btn" style="margin-top:8px"
                    onclick='showImages(${JSON.stringify(completedFiles)})'>‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>`;

          const delBtn = `
            <button onclick="deleteCompletedFile(${row.id}, '${cfUrl}')"
                    style="margin-top:6px; padding:6px 12px; border:1px solid #dc2626;
                           background:#fee2e2; color:#b91c1c; border-radius:6px; cursor:pointer;">
              üóë ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ
            </button>`;

          completedLinks = `<div class="media-container">${cfElement}${cfBtn}${delBtn}</div>`;
        }

        // ----- ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡πÑ‡∏ü‡∏•‡πå" (‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å) -----
        let fileLinks = "-";
        if (mainFiles.length > 0) {
          const first = mainFiles[0];
          const firstUrl = typeof first === 'string'
            ? (first.startsWith('uploads/') ? `/${first}` : first)
            : (((first.url || '').startsWith('uploads/')) ? `/${first.url}` : (first.url || ''));

          const isVideo = (typeof first !== 'string' && first.type === 'video') || /\.(mp4|mov|avi)(\?|$)/i.test(firstUrl);

          const firstElement = isVideo
            ? `<video controls style="width:150px;height:auto;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2);">
                 <source src="${firstUrl}" type="video/mp4">
               </video>`
            : `<img src="${firstUrl}" style="width:150px;height:auto;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2);" />`;

          // üÜï ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏£‡∏π‡∏õ/‡∏Ñ‡∏•‡∏¥‡∏õ‡πÑ‡∏î‡πâ + ‡∏õ‡∏∏‡πà‡∏° "‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡∏°‡∏≠ ‡πÅ‡∏°‡πâ‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
          const clickableFirst =
            `<a href="javascript:void(0)" onclick='showImages(${JSON.stringify(mainFiles)})'>
               ${firstElement}
             </a>`;

          const buttonHtml =
            `<button class="btn" style="margin-top:10px"
                     onclick='showImages(${JSON.stringify(mainFiles)})'>‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>`;

          fileLinks = `<div class="media-container">${clickableFirst}${buttonHtml}</div>`;
        }

        const mapLink = (row.latitude && row.longitude)
          ? `<a class="map-link" href="https://www.google.com/maps?q=${row.latitude},${row.longitude}" target="_blank">üìç ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>`
          : '-';

        const statusSelect = `
          <select onchange="onStatusChange(${row.id}, this.value)" style="padding:6px 8px; border-radius:8px; border:1px solid #cbd5e1;">
            <option value="" disabled ${(row.status == null || row.status === '') ? 'selected' : ''}>‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
            <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" ${row.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" ${row.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" ${row.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'selected' : ''}>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
          </select>
        `;

        tbody.innerHTML += `
          <tr id="row-${row.id}">
            <td>${row.name || '-'}</td>
            <td>${row.phone || '-'}</td>
            <td>${row.message || '-'}</td>
            <td>${fileLinks || '-'}</td>
            <td>${row.department || '-'}</td>
            <td>${statusSelect}</td>
            <td>${mapLink}</td>
            <td>${formatDate(row.created_at)}</td>
            <td>${completedLinks || '-'}</td>
          </tr>
        `;
      });
    }

    // ====== COUNTERS ======
    async function updateCounters() {
      try {
        const [allRes, pRes, iRes, cRes] = await Promise.all([
          fetch('/data-engineer-all?_=' + Date.now()),
          fetch('/data-pending?_=' + Date.now()),
          fetch('/data-in-progress?_=' + Date.now()),
          fetch('/data-completed?_=' + Date.now())
        ]);
        const [allData, pAll, iAll, cAll] = await Promise.all([allRes.json(), pRes.json(), iRes.json(), cRes.json()]);
        const byDept = (r) => ((r.department || '').trim() === DEPT);

        const unset      = (Array.isArray(allData) ? allData : []).filter(r => byDept(r) && (!r.status || String(r.status).trim()==='')).length;
        const pending    = (Array.isArray(pAll) ? pAll : []).filter(byDept).length;
        const inProgress = (Array.isArray(iAll) ? iAll : []).filter(byDept).length;
        const completed  = (Array.isArray(cAll) ? cAll : []).filter(byDept).length;

        const elUnset = document.getElementById('btn-unset');
        if (elUnset) elUnset.textContent = `üìù ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (${unset})`;
        document.getElementById('btn-pending').textContent    = `‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (${pending})`;
        document.getElementById('btn-inprogress').textContent = `‚öôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (${inProgress})`;
        document.getElementById('btn-completed').textContent  = `‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (${completed})`;
      } catch (err) {
        console.error('Error updating counters:', err);
      }
    }

    // ====== HELPERS & ACTIONS ======
    function formatDate(dateString) {
      if (!dateString) return '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏ß‡∏•‡∏≤';
      const date = new Date(dateString);
      if (isNaN(date)) return '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ';
      const options = { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false };
      return date.toLocaleString('th-TH', options);
    }

    function showImages(images) {
      const html = images.map(img => {
        const url = typeof img === 'string'
          ? (img.startsWith('uploads/') ? `/${img}` : img)
          : (((img.url || '').startsWith('uploads/')) ? `/${img.url}` : (img.url || ''));
        const type = (typeof img === 'string') ? '' : (img.type || '');
        if (type === 'video' || url.toLowerCase().match(/\.(mp4|mov|avi)(\?|$)/)) {
          return `<video controls style="width:auto;max-width:700px;max-height:500px;margin-bottom:20px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.2);"><source src="${url}" type="video/mp4"></video>`;
        }
        return `<img src="${url}" style="width:auto;max-width:700px;max-height:500px;margin-bottom:20px;border-radius:8px;object-fit:contain;box-shadow:0 2px 6px rgba(0,0,0,.2);" />`;
      }).join('');
      const win = window.open('', '_blank', 'width=800,height=600');
      win.document.write(`<body style="font-family:kanit;padding:30px;text-align:center;background:#f9f9f9">${html}</body>`);
    }

    async function setStatus(id, status) {
      try {
        const res = await fetch(`/set-status/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        if (!res.ok) throw new Error('update failed');
        alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");

        const idx = allEngineerData.findIndex(r => String(r.id) === String(id));
        if (idx > -1) allEngineerData[idx].status = status;
        applyFilters();
        updateCounters();
      } catch (e) {
        console.error(e);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï");
      }
    }
  </script>
  <script>
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å + ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 60 ‡∏ß‡∏¥
  updateCounters();
  setInterval(updateCounters, 60000);
</script>
<script>
async function refreshData() {
  const btn = document.getElementById('refreshBtn');
  btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä...';
  btn.disabled = true;
  await loadData();
  setTimeout(() => {
    btn.innerHTML = 'üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä';
    btn.disabled = false;
  }, 500);
}
</script>
<!-- ‚úÖ Modal ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏≠‡∏ô "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" -->
<div id="completeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; width:95%; max-width:520px; border-radius:14px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.2);">
    <h3 style="margin:0 0 8px">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</h3>
    <p style="margin:0 0 12px; color:#555">‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‚Äù ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
    <input id="completeFiles" type="file" multiple accept="image/*,video/*" style="display:block; margin-bottom:14px">
    <div style="display:flex; gap:8px; justify-content:flex-end">
      <button onclick="closeCompleteModal()" class="btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button id="btnCompleteUpload" onclick="submitComplete()" class="btn" style="border-color:#15563b;background:#15563b;color:#fff">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
    </div>
  </div>
</div>
<script>
let pendingCompleteId = null;

function onStatusChange(id, value) {
  if (value === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') {
    pendingCompleteId = id;
    openCompleteModal();
  } else {
    setStatus(id, value); // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ä‡πâ endpoint ‡πÄ‡∏î‡∏¥‡∏°
  }
}

function openCompleteModal() {
  document.getElementById('completeModal').style.display = 'flex';
}
function closeCompleteModal() {
  document.getElementById('completeModal').style.display = 'none';
  document.getElementById('completeFiles').value = '';
  pendingCompleteId = null;
}

async function submitComplete() {
  if (!pendingCompleteId) return;
  const btn = document.getElementById('btnCompleteUpload');
  btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';

  try {
    const fd = new FormData();
    const files = document.getElementById('completeFiles').files;
    for (const f of files) fd.append('extraFiles', f);

    const res = await fetch(`/complete-with-media/${pendingCompleteId}`, {
      method: 'POST',
      body: fd
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok || data.success === false) {
      alert(data.message || '‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    } else {
      alert('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      if (typeof loadData === 'function') await loadData();
      if (typeof updateCounters === 'function') await updateCounters();
    }
  } catch (e) {
    console.error(e);
    alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î');
  } finally {
    btn.disabled = false; btn.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
    closeCompleteModal();
  }
}

async function deleteCompletedFile(id, fileUrl) {
  if (!confirm('‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ?')) return;
  try {
    const res = await fetch(`/delete-completed-file/${id}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ fileUrl })
    });
    const data = await res.json();
    alert(data.message);
    if (data.success && typeof loadData === 'function') await loadData();
  } catch (err) {
    console.error(err);
    alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå');
  }
}
</script>

</body>
</html>
