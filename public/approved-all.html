<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‚úÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit&display=swap');
    body {
      font-family: 'Kanit', sans-serif;
      background: #f0fdf4;
      padding: 40px;
    }

    h2 {
      text-align: center;
      color: #166534;
      margin-bottom: 20px;
    }

    .back-btn {
      background: #2563eb;
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: bold;
      margin-bottom: 20px;
      display: inline-block;
    }

    .button-group {
      text-align: center;
      margin-bottom: 30px;
    }

    .dept-btn {
      margin: 6px;
      padding: 10px 18px;
      border-radius: 20px;
      border: none;
      background: #e2e8f0;
      color: #1e293b;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .dept-btn:hover, .dept-btn.active {
      background-color: #2563eb;
      color: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 20px;
    }

    th, td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #14532d;
      color: white;
    }

    img {
      max-width: 120px;
      max-height: 100px;
      border-radius: 6px;
    }

    video {
      max-width: 300px;
      max-height: 200px;
      border-radius: 6px;
    }

    a.map-link {
      color: #2563eb;
      font-weight: bold;
      text-decoration: none;
    }
    .media-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
    }
    .media-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

  </style>
</head>
<body>
  <a class="back-btn" href="/admin">üîô ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
  <h2>‚úÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</h2>

  <div style="text-align:center; margin-bottom: 20px;">
    <input
      type="text"
      id="searchName"
      placeholder="üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..."
      oninput="filterByName()"
      style="padding: 10px; width: 220px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; margin-right: 10px;"
    />

    <input
      type="text"
      id="searchPhone"
      placeholder="üì± ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£..."
      oninput="filterByName()"
      style="padding: 10px; width: 220px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px;"
    />
  </div>

  <div class="button-group">
    <button class="dept-btn" onclick="loadAllApproved(this)">üìã ‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button class="dept-btn" onclick="loadByDept('‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏•‡∏±‡∏î', this)">üè¢ ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏•‡∏±‡∏î</button>
    <button class="dept-btn" onclick="loadByDept('‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç', this)">üè• ‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç</button>
    <button class="dept-btn" onclick="loadByDept('‡∏Å‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á', this)">üõ†Ô∏è ‡∏Å‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á</button>
    <button class="dept-btn" onclick="loadByDept('‡πÑ‡∏ü‡∏ü‡πâ‡∏≤', this)">üí° ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</button>
    <button class="dept-btn" onclick="loadByDept('‡∏≠‡∏∑‡πà‡∏ô‡πÜ', this)">üìÅ ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</button>
  </div>

  <div id="table-container"></div>

  <script>
    let allApprovedData = [];
    let currentDept = null;

    async function loadByDept(dept, btn) {
      document.querySelectorAll('.dept-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentDept = dept;

      const res = await fetch('/data-approved-all');
      const data = await res.json();
      allApprovedData = data;

      const filtered = data.filter(d => d.department === dept);
      renderTable(filtered);
    }

    async function loadAllApproved(btn) {
      document.querySelectorAll('.dept-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentDept = null;

      const res = await fetch('/data-approved-all');
      const data = await res.json();
      allApprovedData = data;

      renderTable(data);
    }

    function renderTable(data) {
      const container = document.getElementById('table-container');
      container.innerHTML = '';

      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>‡∏ä‡∏∑‡πà‡∏≠</th>
            <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
            <th>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</th>
            <th>‡πÑ‡∏ü‡∏•‡πå</th>
            <th>‡πÑ‡∏ü‡∏•‡πå(‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô)</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</th>
            <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà-‡πÄ‡∏ß‡∏•‡∏≤</th>
          </tr>
        </thead>
        <tbody>
          ${data.map(row => {
            // --- ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å row.photo ---
            let files = [];
            try {
              if (row.photo && typeof row.photo === 'string') {
                files = JSON.parse(row.photo);
              } else if (Array.isArray(row.photo)) {
                files = row.photo;
              } else {
                files = [];
              }
            } catch (e) {
              console.error('JSON parse error', e);
              files = [];
            }

            // --- ‡πÅ‡∏¢‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏à‡∏≤‡∏Å "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" ---
            const completedFiles = files.filter(it => {
              if (!it || typeof it !== 'object') return false;
              return it.from === 'completed' || it.tag === 'completed';
            });

            // --- ‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å (‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà completed) ---
            const mainFiles = files.filter(it => {
              if (!it) return false;
              if (typeof it !== 'object') return true; // string ‡πÄ‡∏Å‡πà‡∏≤ ‡πÜ = ‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å
              return !(it.from === 'completed' || it.tag === 'completed');
            });

            // ====== ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡πÑ‡∏ü‡∏•‡πå" (‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏Å) ======
            let mediaHtml = "-";
            if (mainFiles.length > 0) {
              const first = mainFiles[0];
              const firstUrl = typeof first === 'string'
                ? (first.startsWith('uploads/') ? `/${first}` : first)
                : (((first.url || '').startsWith('uploads/')) ? `/${first.url}` : (first.url || ''));
              const firstType = (typeof first === 'string') ? '' : (first.type || '');

              const firstElement = (firstType === 'video' || firstUrl.toLowerCase().match(/\.(mp4|mov|avi)(\?|$)/))
                ? `<video controls style="width:150px;height:auto;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2);">
                     <source src="${firstUrl}" type="video/mp4">
                   </video>`
                : `<img src="${firstUrl}" style="width:150px;height:auto;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2);" />`;

              // ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡∏°‡∏≠ ‡πÅ‡∏°‡πâ‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
              const buttonHtml = `
                <button style="
                      margin-top: 10px;
                      padding: 6px 12px;
                      border: 1px solid #999;
                      border-radius: 6px;
                      background: white;
                      font-weight: bold;
                      cursor: pointer;
                  " onclick='showImages(${JSON.stringify(mainFiles)})'>‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>`;

              mediaHtml = `
                <div class="media-wrapper">
                  ${firstElement}
                  ${buttonHtml}
                </div>
              `;
            }

            // ====== ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡πÑ‡∏ü‡∏•‡πå(‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô)" ======
            let completedHtml = "-";
            if (completedFiles.length > 0) {
              const cf = completedFiles[0];
              const cfUrl = typeof cf === 'string'
                ? (cf.startsWith('uploads/') ? `/${cf}` : cf)
                : (((cf.url || '').startsWith('uploads/')) ? `/${cf.url}` : (cf.url || ''));
              const cfType = (typeof cf === 'string') ? '' : (cf.type || '');

              const cfElement = (cfType === 'video' || cfUrl.toLowerCase().match(/\.(mp4|mov|avi)(\?|$)/))
                ? `<video controls style="width:150px;height:auto;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2);">
                     <source src="${cfUrl}" type="video/mp4">
                   </video>`
                : `<img src="${cfUrl}" style="width:150px;height:auto;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2);" />`;

              const cfBtn = `
                <button style="
                      margin-top: 10px;
                      padding: 6px 12px;
                      border: 1px solid #999;
                      border-radius: 6px;
                      background: white;
                      font-weight: bold;
                      cursor: pointer;
                  " onclick='showImages(${JSON.stringify(completedFiles)})'>‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>`;

              completedHtml = `
                <div class="media-wrapper">
                  ${cfElement}
                  ${cfBtn}
                </div>
              `;
            }

            const mapLink = row.latitude && row.longitude
              ? `<a class="map-link" href="https://www.google.com/maps?q=${row.latitude},${row.longitude}" target="_blank">üìç</a>`
              : "-";

            return `
              <tr>
                <td>${row.name || '-'}</td>
                <td>${row.phone || '-'}</td>
                <td>${row.message || '-'}</td>
                <td>${mediaHtml || '-'}</td>
                <td>${completedHtml || '-'}</td>
                <td>${row.status || '-'}</td>
                <td>${mapLink}</td>
                <td>${row.department || '-'}</td>
                <td>${formatDate(row.created_at)}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      `;
      container.appendChild(table);
    }
  </script>

  <script>
    function formatDate(dateString) {
      if (!dateString) return '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏ß‡∏•‡∏≤';
      const date = new Date(dateString);
      if (isNaN(date)) return '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ';
      const options = {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false
      };
      return date.toLocaleString('th-TH', options);
    }

    function filterByName() {
      const nameKeyword = document.getElementById('searchName').value.trim().toLowerCase();
      const phoneKeyword = document.getElementById('searchPhone').value.trim().toLowerCase();

      let filtered = allApprovedData;

      // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      if (currentDept) {
        filtered = filtered.filter(row => row.department === currentDept);
      }

      // ‡∏Å‡∏£‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå
      filtered = filtered.filter(row =>
        (!nameKeyword || (row.name && row.name.toLowerCase().includes(nameKeyword))) &&
        (!phoneKeyword || (row.phone && row.phone.toLowerCase().includes(phoneKeyword)))
      );

      renderTable(filtered);
    }

    function showImages(images) {
      const html = images.map(img => {
        const url = typeof img === 'string'
          ? (img.startsWith('uploads/') ? `/${img}` : img)
          : (((img.url || '').startsWith('uploads/')) ? `/${img.url}` : (img.url || ''));
        const type = (typeof img === 'string') ? '' : (img.type || '');

        if (type === 'video' || url.toLowerCase().match(/\.(mp4|mov|avi)(\?|$)/)) {
          return `
            <video controls style="
              width: auto;
              max-width: 700px;
              max-height: 500px;
              margin-bottom: 20px;
              border-radius: 8px;
              box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            ">
              <source src="${url}" type="video/mp4">
            </video>`;
        }

        return `
          <img src="${url}" style="
            width: auto;
            max-width: 700px;
            max-height: 500px;
            margin-bottom: 20px;
            border-radius: 8px;
            object-fit: contain;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
          " />`;
      }).join('');

      const win = window.open('', '_blank', 'width=800,height=600');
      win.document.write(`
        <body style="font-family:kanit; padding:30px; text-align:center; background:#f9f9f9">
          ${html}
        </body>
      `);
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const firstBtn = document.querySelector('.dept-btn');
      if (firstBtn) {
        loadAllApproved(firstBtn); // ‡πÇ‡∏´‡∏•‡∏î ‚Äú‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‚Äù ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      }
    });
  </script>

</body>
</html>
