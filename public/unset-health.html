<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>üìù ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ - ‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç</title>
  <style>
    body{font-family:'Kanit',sans-serif;background:#f1f5f9;margin:0;padding:20px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:8px;flex-wrap:wrap}
    h2{margin:0}
    .btn{padding:10px 14px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;font-weight:600}
    .btn.link{color:#15563b;border-color:#15563b}
    .search{padding:10px;width:300px;border-radius:8px;border:1px solid #ccc;font-size:16px}
    table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 0 8px rgba(0,0,0,.1)}
    th,td{padding:10px;border:1px solid #ddd;text-align:center;vertical-align:middle}
    th{background:#15563b;color:#fff}
    img,video{max-width:100%;max-height:300px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    .media-container{display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px 0}
    a.map-link{color:#2563eb;font-weight:bold;text-decoration:none}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <header>
    <h2>üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á ‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç)</h2>
    <div class="toolbar">
      <input id="searchInput" class="search" placeholder="üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå..." oninput="applyFilters()" />
      <button class="btn link" onclick="location.href='admin-health.html'">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç</button>
      <button class="btn" onclick="location.href='pending-health.html'">‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</button>
      <button class="btn" onclick="location.href='inprogress-health.html'">‚öôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</button>
      <button class="btn" onclick="location.href='completed-health.html'">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
    </div>
  </header>

  <table>
    <thead>
      <tr>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</th><th>‡πÑ‡∏ü‡∏•‡πå</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà-‡πÄ‡∏ß‡∏•‡∏≤</th>
      </tr>
    </thead>
    <tbody id="data-body"></tbody>
  </table>

  <script>
    const ENDPOINT_ALL = '/data-health-all';
    const DEPT = '‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç';
    let allData = [], deptData = [];

    async function safeFetchJson(url){
      try{
        const res = await fetch(url);
        const ct = res.headers.get('content-type')||'';
        if(!res.ok || !ct.includes('application/json')) return [];
        return await res.json();
      }catch{ return []; }
    }

    async function loadData(){
      const data = await safeFetchJson(ENDPOINT_ALL + '?_=' + Date.now());
      allData = Array.isArray(data) ? data : [];
      deptData = allData.filter(r =>
        ((r.department||'').trim()===DEPT) &&
        (r.status==null || String(r.status).trim()==='')
      );
      deptData.sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));
      applyFilters();
    }

    function applyFilters(){
      const kw = (document.getElementById('searchInput').value||'').trim().toLowerCase();
      const filtered = deptData.filter(r=>{
        const name=(r.name||'').toLowerCase(), phone=(r.phone||'').toLowerCase();
        return !kw || name.includes(kw) || phone.includes(kw);
      });
      renderTable(filtered);
    }

    function renderTable(rows){
      const tbody=document.getElementById('data-body'); 
      tbody.innerHTML='';
      if(!rows.length){
        tbody.innerHTML=`<tr><td colspan="8">üôà ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</td></tr>`;
        return; 
      }

      rows.forEach(row=>{
        let files=[]; 
        try{
          if(typeof row.photo==='string') files=JSON.parse(row.photo);
          else if(Array.isArray(row.photo)) files=row.photo;
        }catch{}

        let fileLinks='-';
        if(files.length){
          const first=files[0];
          const firstUrl = typeof first==='string'
            ? (first.startsWith('uploads/')?`/${first}`:first)
            : (String(first?.url||'').startsWith('uploads/')?`/${first.url}`:(first?.url||''));
          const isVideo = (typeof first==='string')? false : ((first.type||'')==='video');
          const firstEl = isVideo
            ? `<video controls style="width:150px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2)"><source src="${firstUrl}" type="video/mp4"></video>`
            : `<img src="${firstUrl}" style="width:150px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2)" />`;
          const btnAll = files.length>1 
            ? `<button style="margin-top:10px;padding:6px 12px;border:1px solid #999;border-radius:6px;background:#fff;font-weight:bold;cursor:pointer;" onclick='showImages(${JSON.stringify(files)})'>‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>`
            : '';
          fileLinks = `<div class="media-container">${firstEl}${btnAll}</div>`;
        }

        const mapLink = (row.latitude&&row.longitude)
          ? `<a class="map-link" href="https://www.google.com/maps?q=${row.latitude},${row.longitude}" target="_blank">üìç ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>`
          : '-';

        const statusSelect = `
          <select onchange="setStatus(${row.original_id || row.id}, this.value)">
            <option value="" selected>‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
            <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
            <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
          </select>`;

        tbody.innerHTML += `
          <tr>
            <td>${row.name||'-'}</td>
            <td>${row.phone?`<a href="tel:${row.phone}">${row.phone}</a>`:'-'}</td>
            <td>${row.message||'-'}</td>
            <td>${fileLinks}</td>
            <td>${row.department||'-'}</td>
            <td>${statusSelect}</td>
            <td>${mapLink}</td>
            <td>${formatDate(row.created_at)}</td>
          </tr>`;
      });
    }

    function formatDate(s){
      if(!s) return '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏ß‡∏•‡∏≤';
      const d=new Date(s);
      if(isNaN(d)) return '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ';
      return d.toLocaleString('th-TH',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
    }

    function showImages(images){
      const html = images.map(img=>{
        const url = typeof img==='string'
          ? (img.startsWith('uploads/')?`/${img}`:img)
          : (String(img?.url||'').startsWith('uploads/')?`/${img.url}`:(img?.url||''));
        const type = (typeof img==='string')?'':(img.type||'');
        if(type==='video' || url.toLowerCase().match(/\.(mp4|mov|avi)(\?|$)/)){
          return `<video controls style="max-width:700px;max-height:500px;margin-bottom:20px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.2)"><source src="${url}" type="video/mp4"></video>`;
        }
        return `<img src="${url}" style="max-width:700px;max-height:500px;margin-bottom:20px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.2)" />`;
      }).join('');
      const win=window.open('','_blank','width=800,height=600');
      win.document.write(`<body style="font-family:kanit;padding:30px;text-align:center;background:#f9f9f9">${html}</body>`);
    }

    async function setStatus(id,status){
      try{
        const res = await fetch(`/set-status/${id}`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({status})
        });
        if(res.ok){
          alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
          loadData();
        }else{
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï');
        }
      }catch{
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï');
      }
    }

    loadData();
  </script>
</body>
</html>
