<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ - ‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç</title>

  <style>
    body{font-family:'Kanit',sans-serif;background:#f1f5f9;margin:0;padding:20px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:8px;flex-wrap:wrap}
    h2{margin:0}

    .btn{
      padding:10px 14px;border-radius:8px;
      border:1px solid #cbd5e1;background:#fff;
      cursor:pointer;font-weight:600
    }
    .btn.link{color:#15563b;border-color:#15563b}

    .search{
      padding:10px;width:300px;border-radius:8px;
      border:1px solid #ccc;font-size:16px
    }

    table{
      width:100%;border-collapse:collapse;
      background:#fff;
      box-shadow:0 0 8px rgba(0,0,0,.1)
    }
    th,td{
      padding:10px;border:1px solid #ddd;
      text-align:center;vertical-align:middle
    }
    th{background:#15563b;color:#fff}

    .media-container{
      display:flex;flex-direction:column;
      align-items:center;gap:8px;padding:6px 0
    }

    a.map-link{
      color:#2563eb;font-weight:bold;text-decoration:none
    }

    .toolbar{
      display:flex;gap:10px;
      align-items:center;flex-wrap:wrap
    }

    /* ---------- pagination ---------- */
    #pagination{
      margin-top:10px;
      display:flex;justify-content:center;
      align-items:center;gap:8px
    }

    /* ---------- modal ---------- */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .modal{
      width:min(560px, 94vw);
      background:#fff;
      border-radius:14px;
      box-shadow:0 12px 30px rgba(0,0,0,.25);
      padding:18px;
    }
    .modal h3{ margin:0 0 10px; }
    .modal .row{
      display:flex; gap:10px;
      flex-wrap:wrap; align-items:center;
    }
    .modal .actions{
      display:flex; gap:10px;
      justify-content:flex-end;
      margin-top:12px;
    }
    .btn.primary{
      background:#15563b;
      color:#fff;
      border-color:#15563b;
    }
    .hint{
      color:#666;
      font-size:13px;
      margin-top:6px;
    }
  </style>
</head>

<body>

<header>
  <h2>‚è≥ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á ‚Äî ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç)</h2>
  <div class="toolbar">
    <input id="searchInput" class="search"
      placeholder="üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå..."
      oninput="applyFilters()" />

    <button class="btn link"
      onclick="location.href='admin-health.html'">
      ‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ ‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç
    </button>

    <button class="btn"
      onclick="location.href='inprogress-health.html'">
      ‚öôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
    </button>

    <button class="btn"
      onclick="location.href='completed-health.html'">
      ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
    </button>
  </div>
</header>

<table>
  <thead>
    <tr>
      <th>‡∏ä‡∏∑‡πà‡∏≠</th>
      <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th>
      <th>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</th>
      <th>‡πÑ‡∏ü‡∏•‡πå</th>
      <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
      <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
      <th>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</th>
      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà-‡πÄ‡∏ß‡∏•‡∏≤</th>
    </tr>
  </thead>
  <tbody id="data-body"></tbody>
</table>

<div id="pagination">
  <button id="prevPage" onclick="changePage(-1)" class="btn">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
  <span id="pageInfo">‡∏´‡∏ô‡πâ‡∏≤ 1 ‡∏à‡∏≤‡∏Å 1</span>
  <button id="nextPage" onclick="changePage(1)" class="btn">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
</div>

<script>
  /* ===============================
     CONFIG
  =============================== */
  const ENDPOINT = '/data-pending?department=‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç';
  const pageSize = 20;

  let allData = [];
  let deptData = [];
  let filteredRows = [];
  let currentPage = 1;

  /* ===============================
     LOAD DATA
  =============================== */
  async function loadData(){
    try{
      const res = await fetch(`${ENDPOINT}&_=${Date.now()}`);
      const data = await res.json();
      allData = Array.isArray(data) ? data : [];
    }catch{
      allData = [];
    }

    // ‡∏Å‡∏±‡∏ô‡∏û‡∏•‡∏≤‡∏î
    deptData = allData.filter(r => (r.department || '') === '‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç');
    applyFilters();
  }

  /* ===============================
     SEARCH
  =============================== */
  function applyFilters(){
    const kw = document.getElementById('searchInput')
      .value.trim().toLowerCase();

    filteredRows = deptData.filter(r=>{
      const name = (r.name||'').toLowerCase();
      const phone = (r.phone||'').toLowerCase();
      return !kw || name.includes(kw) || phone.includes(kw);
    });

    currentPage = 1;
    renderCurrentPage();
  }

  /* ===============================
     PAGINATION
  =============================== */
  function renderCurrentPage(){
    const totalItems = filteredRows.length;
    const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
    if(currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage-1) * pageSize;
    const pageData = filteredRows.slice(start, start + pageSize);

    renderTable(pageData);

    document.getElementById('pageInfo').textContent =
      `‡∏´‡∏ô‡πâ‡∏≤ ${currentPage} ‡∏à‡∏≤‡∏Å ${totalPages} (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;

    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = currentPage === totalPages;
  }

  function changePage(delta){
    currentPage += delta;
    renderCurrentPage();
  }

  /* ===============================
     TABLE
  =============================== */
  function renderTable(rows){
    const tbody = document.getElementById('data-body');
    tbody.innerHTML = '';

    if(!rows || rows.length === 0){
      tbody.innerHTML = `
        <tr>
          <td colspan="8"
            style="padding:35px;text-align:center;
                   color:#555;font-size:18px;">
            üì≠ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            ‚Äú‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‚Äù ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç
          </td>
        </tr>`;
      return;
    }

    rows.forEach(row=>{
      const id = row.original_id || row.id;

      let files=[];
      try{
        if(typeof row.photo === 'string') files = JSON.parse(row.photo);
        else if(Array.isArray(row.photo)) files = row.photo;
      }catch{ files=[] }

      let fileCell = '-';
      if(files.length>0){
        fileCell = `
          <div class="media-container">
            <button class="btn"
              onclick='showImages(${JSON.stringify(files)})'>
              ‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
          </div>`;
      }

      const mapLink = (row.latitude && row.longitude)
        ? `<a class="map-link"
            href="https://www.google.com/maps?q=${row.latitude},${row.longitude}"
            target="_blank">üìç ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>`
        : '-';

      const statusSelect = `
        <select onchange="onStatusChange(${id}, this.value)">
          <option disabled ${!row.status?'selected':''}>
            ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
          </option>
          <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£"
            ${row.status==='‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'?'selected':''}>
            ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
          </option>
          <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£"
            ${row.status==='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'?'selected':''}>
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
          </option>
          <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"
            ${row.status==='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'?'selected':''}>
            ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
          </option>
        </select>`;

      tbody.innerHTML += `
        <tr>
          <td>${row.name||'-'}</td>
          <td>${row.phone||'-'}</td>
          <td>${row.message||'-'}</td>
          <td>${fileCell}</td>
          <td>${row.department||'-'}</td>
          <td>${statusSelect}</td>
          <td>${mapLink}</td>
          <td>${formatDate(row.created_at)}</td>
        </tr>`;
    });
  }

  function formatDate(s){
    if(!s) return '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏ß‡∏•‡∏≤';
    const d = new Date(s);
    if(isNaN(d)) return '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ';
    return d.toLocaleString('th-TH',{
      year:'numeric',month:'2-digit',day:'2-digit',
      hour:'2-digit',minute:'2-digit',second:'2-digit',
      hour12:false
    });
  }

  /* ===============================
     IMAGE VIEW
  =============================== */
  function showImages(images){
    const html = images.map(img=>{
      const url = typeof img === 'string'
        ? (img.startsWith('uploads/')?`/${img}`:img)
        : (String(img.url||'').startsWith('uploads/')
            ? `/${img.url}` : img.url);

      const type = (typeof img === 'string') ? '' : (img.type||'');

      if(type==='video' || url.match(/\.(mp4|mov|avi)(\?|$)/i)){
        return `<video controls style="max-width:700px;
          margin-bottom:20px;border-radius:8px;">
          <source src="${url}" type="video/mp4"></video>`;
      }
      return `<img src="${url}"
        style="max-width:700px;margin-bottom:20px;
        border-radius:8px;object-fit:contain;" />`;
    }).join('');

    const win = window.open('','_blank','width=800,height=600');
    win.document.write(
      `<body style="font-family:Kanit;
      padding:30px;text-align:center;background:#f9f9f9">
      ${html}</body>`
    );
  }

  /* ===============================
     STATUS
  =============================== */
  function onStatusChange(id,status){
    if(status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'){
      openCompleteModal(id);
      return;
    }
    setStatus(id,status);
  }

  function setStatus(id,status){
    fetch(`/set-status/${id}`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({status})
    })
    .then(()=>loadData())
    .catch(()=>alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'));
  }

  /* ===============================
     COMPLETE MODAL
  =============================== */
  let completeTargetId = null;

  function openCompleteModal(id){
    completeTargetId = id;
    document.getElementById('completeFiles').value = '';
    document.getElementById('completeModal').style.display = 'flex';
  }

  function closeCompleteModal(){
    completeTargetId = null;
    document.getElementById('completeModal').style.display = 'none';
  }

  async function submitComplete(){
    if(!completeTargetId) return;

    const fd = new FormData();
    const files = document.getElementById('completeFiles').files;
    for(const f of files) fd.append('extraFiles', f);

    await fetch(`/complete-with-media/${completeTargetId}`,{
      method:'POST',
      body:fd
    });

    closeCompleteModal();
    loadData();
  }

  loadData();
</script>

<div id="completeModal" class="modal-backdrop">
  <div class="modal">
    <h3>‚úÖ ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô)</h3>

    <div class="row">
      <input id="completeFiles"
        type="file" multiple
        accept="image/*,video/*">
    </div>

    <div class="hint">
      * ‡πÑ‡∏°‡πà‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πá‡πÑ‡∏î‡πâ ‡∏Å‡∏î ‚Äú‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‚Äù ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
    </div>

    <div class="actions">
      <button class="btn" onclick="closeCompleteModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn primary" onclick="submitComplete()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
    </div>
  </div>
</div>

</body>
</html>
