<!-- public/track.html -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>üîç ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit&display=swap');

    body {
      font-family: 'Kanit', sans-serif;
      background: #e3f2fd;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
      /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô <style> */
    .back-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background-color: #ff9800;
      color: white;
      padding: 10px 18px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      z-index: 1000; /* ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏¢‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ element ‡∏≠‡∏∑‡πà‡∏ô */
    }
    .back-btn:hover {
      background-color: #f57c00;
    }

    h2 {
      margin-top: 40px;
      color: #1976d2;
    }

    form {
      background: #ffffff;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    input[type="tel"] {
      padding: 12px 16px;
      font-size: 16px;
      border: 1.5px solid #90caf9;
      border-radius: 8px;
      margin-bottom: 12px;
      width: 260px;
      background-color: #f0faff;
    }

    button {
      background-color: #1976d2;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #1565c0;
    }

    #results {
      margin-top: 30px;
      width: 90%;
      max-width: 600px;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    #results p {
      margin: 8px 0;
    }

    hr {
      margin: 20px 0;
      border: none;
      border-top: 1px solid #ccc;
    }

    @media (max-width: 480px) {
      input[type="tel"], button {
        width: 100%;
      }

      form {
        width: 90%;
      }
    }
  .media-grid { display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; }
  .media-grid img, .media-grid video { width:140px; height:100px; object-fit:cover; border-radius:8px; }
  .chip { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#e8f5e9; color:#1b5e20; }
  </style>
</head>
<body>

  <a href="/choose.html" class="back-btn">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>

  <h2>üîç ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</h2>
  <form id="trackForm">
    <input type="tel" id="phone" required placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ‡πÄ‡∏ä‡πà‡∏ô 0891234567" />
    <button type="submit">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
  </form>

  <div id="results"></div>

  <script>
  function formatDate(dateString) {
    if (!dateString) return '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏ß‡∏•‡∏≤';
    const fixed = String(dateString).trim().replace(' ', 'T');
    const d = new Date(fixed);
    if (isNaN(d)) return '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ';
    return d.toLocaleString('th-TH', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit',
      hour12: false
    });
  }

  async function fetchRequests(phone) {
  const res = await fetch('/track-requests', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ phone })
  });

  const data = await res.json();
  const resultsDiv = document.getElementById('results');
  resultsDiv.innerHTML = '';

  if (!Array.isArray(data) || data.length === 0) {
    resultsDiv.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á';
    return;
  }

  data.forEach(row => {
    const photos = parsePhoto(row.photo);
    const completedFiles = photos.filter(it => {
      if (!it || typeof it !== 'object') return false;
      return it.from === 'completed' || it.tag === 'completed';
    });

    let html = `
      <hr/>
      <p><strong>üìÑ ‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á:</strong> ${row.id}</p>
      <p><strong>üìù ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:</strong> ${row.message}</p>
      <p><strong>üïì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á:</strong> ${formatDate(row.created_at)}</p>
      <p><strong>üìå ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${row.status || '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}</p>
    `;

    if (row.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' && row.completed_at) {
      html += `<p><span class="chip">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDate(row.completed_at)}</span></p>`;
    }

    if (row.status === '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' && row.reject_reason) {
      html += `<p><strong>‚ùó ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${row.reject_reason}</p>`;
    }

    // üîΩ ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏ï‡∏≠‡∏ô "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"
    if (completedFiles.length > 0) {
      const thumbs = completedFiles.slice(0, 4).map(it => {
        const url = typeof it === 'string' ? normUrl(it) : normUrl(it.url);
        const isVideo = (it.type === 'video') || /\.(mp4|mov|avi)(\?|$)/i.test(url);
        return isVideo
          ? `<video muted class="thumb"><source src="${url}" type="video/mp4"></video>`
          : `<img class="thumb" src="${url}" alt="">`;
      }).join('');

      html += `
        <div style="margin-top:8px;">
          <strong>üì∑ ‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô):</strong>
          <div class="media-grid">${thumbs}</div>
          <button style="margin-top:8px" onclick='showImages(${JSON.stringify(completedFiles)})'>‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
      `;
    }

    resultsDiv.innerHTML += html;
  });
}

  document.addEventListener("DOMContentLoaded", () => {
    const savedPhone = localStorage.getItem("phone");

    if (savedPhone) {
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° ‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      document.getElementById("trackForm").style.display = "none";
      fetchRequests(savedPhone);
    } else {
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå ‚Üí ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
      document.getElementById('trackForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const phone = document.getElementById('phone').value;
        localStorage.setItem("phone", phone); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤
        fetchRequests(phone);
      });
    }
  });
</script>
<script>
  function normUrl(u) {
    if (!u) return '';
    return u.startsWith('uploads/') ? '/' + u : u; // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô path
  }

  function showImages(images) {
    const html = images.map(it => {
      const url = typeof it === 'string' ? normUrl(it) : normUrl(it.url);
      const isVideo = (typeof it === 'object' ? it.type : '') === 'video' || /\.(mp4|mov|avi)(\?|$)/i.test(url);
      return isVideo
        ? `<video controls style="max-width:720px; max-height:540px; margin:10px 0; border-radius:8px;"><source src="${url}" type="video/mp4"></video>`
        : `<img src="${url}" style="max-width:720px; max-height:540px; margin:10px 0; border-radius:8px; object-fit:contain;">`;
    }).join('');
    const w = window.open('', '_blank', 'width=800,height=650');
    w.document.write(`<body style="font-family:Kanit; padding:24px; background:#fafafa; text-align:center">${html}</body>`);
  }

  function parsePhoto(val) {
    if (!val) return [];
    try { return Array.isArray(val) ? val : JSON.parse(val); }
    catch { return []; }
  }
</script>

</body>
</html>
