<!DOCTYPE html>
<html lang="th">
<head>
  <link rel="manifest" href="/manifest-electric.json">
  <meta name="theme-color" content="#155263">

  <meta charset="UTF-8" />
  <title>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á - ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</title>
  <style>
    body { font-family: 'Kanit', sans-serif; background: #f1f5f9; margin: 0; padding: 20px; }
    h2 { text-align: center; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: center; vertical-align: middle; }
    th { background: #15563b; color: white; }
    img, video { max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
    video.rotated-180 { transform: rotate(180deg); }
    .media-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  padding: 10px 0;
}

    a.map-link { color: #2563eb; font-weight: bold; text-decoration: none; }
  </style>
</head>
<body>
  <h2>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á - ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</h2>
  <div style="text-align:center; margin-bottom: 20px;">
  <input type="text" id="searchInput" placeholder="üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." oninput="filterByName()" style="
    padding: 10px;
    width: 300px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 16px;
    
  " />
  <button id="refreshBtn" class="btn" onclick="refreshData()" style="margin-left:8px;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
</div>
<div style="text-align:center; margin:-8px 0 16px;">
  <!-- üÜï ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà -->
  <button id="btn-unset" onclick="location.href='unset-electric.html'"
          style="padding:10px 14px; border-radius:8px; border:1px solid #eab308; background:#fff8e1; color:#92400e; font-weight:600; cursor:pointer; margin-right:6px;">
    üìù ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (0)
  </button>

  <button id="btn-pending" onclick="location.href='pending-electric.html'"
          style="padding:10px 14px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; font-weight:600; cursor:pointer;">
    ‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (0)
  </button>
  <button id="btn-inprogress" onclick="location.href='inprogress-electric.html'"
          style="padding:10px 14px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; font-weight:600; cursor:pointer; margin-left:6px;">
    ‚öôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (0)
  </button>
  <button id="btn-completed" onclick="location.href='completed-electric.html'"
          style="padding:10px 14px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; font-weight:600; cursor:pointer; margin-left:6px;">
    ‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (0)
  </button>
</div>




  <table>
    <thead>
      <tr>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå</th><th>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</th><th>‡πÑ‡∏ü‡∏•‡πå</th><th>‡πÅ‡∏ú‡∏ô‡∏Å</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà-‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÑ‡∏ü‡∏•‡πå(‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô)</th>
      </tr>
    
    </thead>
    <tbody id="data-body"></tbody>
  </table>
    <div id="pagination"
       style="margin-top:10px; display:flex; justify-content:center; align-items:center; gap:8px;">
    <button id="prevPage"
            onclick="changePage(-1)"
            style="padding:6px 12px; border-radius:6px; border:1px solid #cbd5e1; cursor:pointer;">
      ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    </button>

    <span id="pageInfo">‡∏´‡∏ô‡πâ‡∏≤ 1 ‡∏à‡∏≤‡∏Å 1</span>

    <button id="nextPage"
            onclick="changePage(1)"
            style="padding:6px 12px; border-radius:6px; border:1px solid #cbd5e1; cursor:pointer;">
      ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
    </button>
  </div>

  <script>
  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î + ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤
  let allElectricData = [];   // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å server
  let filteredData = [];      // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏Ø‡∏•‡∏Ø)
  let currentPage = 1;        // ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  const pageSize = 20;        // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô 10/30 ‡πÑ‡∏î‡πâ)

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å server
  async function loadData() {
    const res = await fetch('/data-electric-all?_=' + Date.now());
    const data = await res.json();

    allElectricData = data;
    filteredData = data;
    currentPage = 1;

    renderCurrentPage();   // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  }

  // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  function renderCurrentPage() {
    const totalItems = filteredData.length;
    const totalPages = Math.max(1, Math.ceil(totalItems / pageSize));
    if (currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageData = filteredData.slice(start, end);

    renderTable(pageData);   // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderTable ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤

    const info = document.getElementById('pageInfo');
    if (info) {
      info.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${currentPage} ‡∏à‡∏≤‡∏Å ${totalPages} (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
    }

    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    if (prevBtn) prevBtn.disabled = currentPage === 1;
    if (nextBtn) nextBtn.disabled = currentPage === totalPages;
  }

  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
  function changePage(delta) {
    currentPage += delta;
    renderCurrentPage();
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
  function renderTable(data) {
    const tbody = document.getElementById('data-body');
    tbody.innerHTML = '';
    
    data.forEach(row => {
      let files = [];
      try {
        if (row.photo && typeof row.photo === 'string') {
          files = JSON.parse(row.photo);
        } else if (Array.isArray(row.photo)) {
          files = row.photo;
        } else {
          files = [];
        }
      } catch (e) {
        console.error('JSON parse error', e);
        files = [];
      }

      // ‚úÖ ‡πÅ‡∏¢‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
      const completedFiles = files.filter(it => {
        if (!it || typeof it !== 'object') return false;
        return it.from === 'completed' || it.tag === 'completed';
      });

      const mainFiles = files.filter(it => {
        if (!it) return false;
        if (typeof it !== 'object') return true;
        return !(it.from === 'completed' || it.tag === 'completed');
      });

      // üîπ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÑ‡∏ü‡∏•‡πå(‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô) ‚Äì ‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î + ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå
      let completedLinks = "-";
      if (completedFiles.length > 0) {
        const cf = completedFiles[0];
        const cfUrl = typeof cf === 'string'
          ? (cf.startsWith('uploads/') ? `/${cf}` : cf)
          : (cf.url.startsWith('uploads/') ? `/${cf.url}` : cf.url);

        const cfBtn = `
          <button style="margin-top:10px; padding:6px 12px; border:1px solid #999; border-radius:6px; background:#fff; font-weight:bold; cursor:pointer;"
                  onclick='showImages(${JSON.stringify(completedFiles)})'>
            ‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          </button>`;

        completedLinks = `
          <div class="media-container">
            ${cfBtn}
            <button onclick="deleteCompletedFile(${row.id}, '${cfUrl}')"
              style="margin-top:6px; padding:6px 12px; border:1px solid #dc2626;
                    background:#fee2e2; color:#b91c1c; border-radius:6px; cursor:pointer;">
              üóë ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ
            </button>
          </div>
        `;
      }

      // üîπ ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏Å‡∏ï‡∏¥ ‚Äì ‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      let fileLinks = "-";
      if (mainFiles.length > 0) {
        const buttonHtml =
          `<button style="margin-top:10px; padding:6px 12px; border:1px solid #999; border-radius:6px; background:#fff; font-weight:bold; cursor:pointer;"
                  onclick='showImages(${JSON.stringify(mainFiles)})'>‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>`;

        fileLinks = `<div class="media-container">${buttonHtml}</div>`;
      }

      const mapLink = row.latitude && row.longitude
        ? `<a class="map-link" href="https://www.google.com/maps?q=${row.latitude},${row.longitude}" target="_blank">üìç ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>`
        : '-';

      const statusSelect = `
        <select onchange="onStatusChange(${row.id}, this.value)">
          <option value="" disabled ${(row.status === null || row.status === undefined || row.status === '') ? 'selected' : ''}>‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
          <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" ${row.status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
          <option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£" ${row.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' ? 'selected' : ''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
          <option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" ${row.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'selected' : ''}>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
        </select>
      `;

      tbody.innerHTML += `
         <tr id="row-${row.id}">
           <td>${row.name || '-'}</td>
           <td>${row.phone || '-'}</td>
           <td>${row.message || '-'}</td>
           <td>${fileLinks || '-'}</td>
           <td>${row.department || '-'}</td>
           <td>${statusSelect}</td>
           <td>${mapLink}</td>
           <td>${formatDate(row.completed_at || row.created_at)}</td>
           <td>${completedLinks || '-'}</td>
         </tr>
       `;
    });
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
  loadData();
</script>

  <script>
  function formatDate(dateString) {
  if (!dateString) return '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏ß‡∏•‡∏≤';
  const date = new Date(dateString);
  if (isNaN(date)) return '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ';
  const options = {
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', second: '2-digit',
    hour12: false
  };
  return date.toLocaleString('th-TH', options);
}
  function filterByName() {
  const keyword = document.getElementById('searchInput').value.trim().toLowerCase();

  // ‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô filteredData
  filteredData = allElectricData.filter(row =>
    (row.name && row.name.toLowerCase().includes(keyword)) ||
    (row.phone && row.phone.toLowerCase().includes(keyword))
  );

  currentPage = 1;       // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ 1
  renderCurrentPage();   // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤ + ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤/‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
}

  function showImages(images) {
    const html = images.map(img => {
      const url = typeof img === 'string'
      ? (img.startsWith('uploads/') ? `/${img}` : img)
      : (img.url.startsWith('uploads/') ? `/${img.url}` : img.url);



      const type = img.type || "";

      if (type === 'video' || url.toLowerCase().match(/\.(mp4|mov|avi)(\?|$)/)) {
        return `
          <video controls style="
            width: auto;
            max-width: 700px;
            max-height: 500px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
          ">
            <source src="${url}" type="video/mp4">
          </video>`;
      }

      return `
        <img src="${url}" style="
          width: auto;
          max-width: 700px;
          max-height: 500px;
          margin-bottom: 20px;
          border-radius: 8px;
          object-fit: contain;
          box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        " />`;
    }).join('');

    const win = window.open('', '_blank', 'width=800,height=600');
    win.document.write(`
      <body style="font-family:kanit; padding:30px; text-align:center; background:#f9f9f9">
        ${html}
      </body>
    `);
  }

  </script>
  <script>
    function setStatus(id, status) {
  fetch(`/set-status/${id}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status })
  })
  .then(res => {
    if (res.ok) {
      alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      if (typeof updateCounters === 'function') updateCounters();
    } else {
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï');
    }
  })
  .catch(err => {
    console.error(err);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï');
  });
}

  </script>
  <script>
async function updateCounters() {
  const DEPT = '‡πÑ‡∏ü‡∏ü‡πâ‡∏≤';
  try {
    const [allRes, pRes, iRes, cRes] = await Promise.all([
      fetch('/data-electric-all?_=' + Date.now()),
      fetch('/data-pending?department=' + encodeURIComponent(DEPT) + '&_=' + Date.now()),
      fetch('/data-in-progress?department=' + encodeURIComponent(DEPT) + '&_=' + Date.now()),
      fetch('/data-completed?department=' + encodeURIComponent(DEPT) + '&_=' + Date.now())
    ]);
    const [allData, pAll, iAll, cAll] = await Promise.all([
      allRes.json(), pRes.json(), iRes.json(), cRes.json()
    ]);

    const byDept = (r) => ((r.department || '').trim() === DEPT);

    const unset      = (Array.isArray(allData) ? allData : []).filter(r => byDept(r) && (!r.status || r.status.trim()==='')).length;
    const pending    = Array.isArray(pAll) ? pAll.length : 0;
    const inProgress = Array.isArray(iAll) ? iAll.length : 0;
    const completed  = Array.isArray(cAll) ? cAll.length : 0;


    document.getElementById('btn-unset').textContent      = `üìù ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (${unset})`;
    document.getElementById('btn-pending').textContent    = `‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (${pending})`;
    document.getElementById('btn-inprogress').textContent = `‚öôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ (${inProgress})`;
    document.getElementById('btn-completed').textContent  = `‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (${completed})`;
  } catch (err) {
    console.error('Error updating counters:', err);
  }
}

</script>
<script>
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å + ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 60 ‡∏ß‡∏¥
  updateCounters();
  setInterval(updateCounters, 60000);
</script>
<script>
async function refreshData() {
  const btn = document.getElementById('refreshBtn');
  btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä...';
  btn.disabled = true;
  await loadData();
  setTimeout(() => {
    btn.innerHTML = 'üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä';
    btn.disabled = false;
  }, 500);
}
</script>
<!-- ‚úÖ Modal ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏≠‡∏ô "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" -->
<div id="completeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; width:95%; max-width:520px; border-radius:14px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.2);">
    <h3 style="margin:0 0 8px">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</h3>
    <p style="margin:0 0 12px; color:#555">‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‚Äù ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ/‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>

    <input id="completeFiles" type="file" multiple accept="image/*,video/*" style="display:block; margin-bottom:14px">

    <div style="display:flex; gap:8px; justify-content:flex-end">
      <button onclick="closeCompleteModal()" style="padding:8px 12px; border:1px solid #ccc; background:#fff; border-radius:8px; cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button id="btnCompleteUpload" onclick="submitComplete()" style="padding:8px 12px; border:1px solid #15563b; background:#15563b; color:#fff; border-radius:8px; cursor:pointer;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
    </div>
  </div>
</div>
<script>
let pendingCompleteId = null;

function onStatusChange(id, value) {
  if (value === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') {
    // ‡πÄ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡πà‡∏á‡πÑ‡∏õ /complete-with-media/:id
    pendingCompleteId = id;
    openCompleteModal();
  } else {
    // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
    setStatus(id, value);
  }
}

function openCompleteModal() {
  document.getElementById('completeModal').style.display = 'flex';
}
function closeCompleteModal() {
  document.getElementById('completeModal').style.display = 'none';
  document.getElementById('completeFiles').value = '';
  pendingCompleteId = null;
}
async function deleteCompletedFile(id, fileUrl) {
  if (!confirm('‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ?')) return;

  try {
    const res = await fetch(`/delete-completed-file/${id}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ fileUrl })
    });
    const data = await res.json();
    alert(data.message);
    if (data.success) await loadData(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏•‡∏ö
  } catch (err) {
    console.error(err);
    alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå');
  }
}

async function submitComplete() {
  if (!pendingCompleteId) return;

  const btn = document.getElementById('btnCompleteUpload');
  btn.disabled = true;
  btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';

  try {
    const fd = new FormData();
    const files = document.getElementById('completeFiles').files;
    // ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πá‡∏™‡πà‡∏á‡∏ß‡πà‡∏≤‡∏á ‡πÜ ‡πÑ‡∏î‡πâ)
    for (const f of files) fd.append('extraFiles', f);

    const res = await fetch(`/complete-with-media/${pendingCompleteId}`, {
      method: 'POST',
      body: fd
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || data.success === false) {
      alert(data.message || '‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    } else {
      alert('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö
      if (typeof loadData === 'function') await loadData();
      if (typeof updateCounters === 'function') await updateCounters();
    }
  } catch (err) {
    console.error(err);
    alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î');
  } finally {
    btn.disabled = false;
    btn.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
    closeCompleteModal();
  }
}
</script>


</body>
</html>
